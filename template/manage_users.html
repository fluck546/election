{% extends 'base.html' %}

{% block title %}Manage Users{% endblock %}

{% block content %}
<div class="bg-white p-6 rounded-lg shadow-md">
  <h1 class="text-2xl font-bold mb-6">จัดการข้อมูลผู้ใช้</h1>
  <button onclick="openAddUserModal()" class="mb-4 bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded">เพิ่มผู้ใช้</button>
  <!-- CSV Upload Form -->
  <form method="POST" enctype="multipart/form-data">
    {% csrf_token %}
    <label class="block text-gray-700">Upload CSV File:</label>
    <input
      type="file"
      name="csv_file"
      accept=".csv"
      class="bg-gray-100 border border-gray-300 rounded-md py-2 px-4 w-full mb-4"
      required
    />
    <button
      type="submit"
      class="bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded"
    >
      เพิ่มข้อมูลผ่าน CSV
    </button>
  </form>
  <div class="overflow-x-auto mb-4">
    <!-- DataTable -->
    <table id="userTable" class="dataTable min-w-full bg-white border border-gray-300 rounded-lg mt-10">
      <thead class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
        <tr>
          <th class="py-3 px-6 text-left">รหัสนักศึกษา</th>
          <th class="py-3 px-6 text-left">อีเมล</th>
          <th class="py-3 px-6 text-left">ชื่อ-สกุล</th>
          <th class="py-3 px-6 text-left">สาขา</th>
          <th class="py-3 px-6 text-left">สถานะผู้ใช้ (Active)</th> <!-- Added is_active column -->
          <th class="py-3 px-6 text-left">สถานะเจ้าหน้าที่ (Staff)</th> <!-- Added is_staff column -->
          <th class="py-3 px-6 text-center">Actions</th>
        </tr>
      </thead>
      <tbody class="text-gray-700 text-sm font-light">
        {% for user in users %}
        <tr class="border-b border-gray-200 hover:bg-gray-100">
          <td class="py-3 px-6">{{ user.sid }}</td>
          <td class="py-3 px-6">{{ user.email }}</td>
          <td class="py-3 px-6">{{ user.name }} {{ user.last_name }}</td>
          <td class="py-3 px-6">{{ user.branch }}</td>
          <td class="py-3 px-6">{{ user.is_active|yesno:"ใช่,ไม่" }}</td> <!-- Display is_active -->
          <td class="py-3 px-6">{{ user.is_staff|yesno:"ใช่,ไม่" }}</td> <!-- Display is_staff -->
          <td class="py-3 px-6 text-center">
            <button onclick="openEditUserModal('{{ user.id }}')" class="bg-blue-500 hover:bg-blue-600 text-white py-1 px-3 rounded">Edit</button>
            <button onclick="confirmDeleteUser('{{ user.id }}')" class="bg-red-500 hover:bg-red-600 text-white py-1 px-3 rounded ml-2">Delete</button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  
<!-- Add User Modal -->
<div id="addUserModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden modal">
  <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-lg modal-content">
    <h2 class="text-xl font-bold mb-4">เพิ่มผู้ใช้</h2>
    <form method="POST" action="{% url 'add_user' %}">
      {% csrf_token %}
      <!-- Input fields for adding a user -->
      <div class="mb-4">
        <label for="sid" class="block text-gray-700">รหัสนักศึกษา:</label>
        <input type="text" id="sid" name="sid" class="bg-gray-100 border border-gray-300 rounded-md py-2 px-3 w-full" />
      </div>
      <div class="mb-4">
        <label for="name" class="block text-gray-700">ชื่อ:</label>
        <input type="text" id="name" name="name" class="bg-gray-100 border border-gray-300 rounded-md py-2 px-3 w-full" />
      </div>
      <div class="mb-4">
        <label for="last_name" class="block text-gray-700">นามสกุุล:</label>
        <input type="text" id="last_name" name="last_name" class="bg-gray-100 border border-gray-300 rounded-md py-2 px-3 w-full" />
      </div>
      <div class="mb-4">
        <label for="branch" class="block text-gray-700">สาขา:</label>
        <input type="text" id="branch" name="branch" class="bg-gray-100 border border-gray-300 rounded-md py-2 px-3 w-full" />
      </div>
      <div class="mb-4">
        <label for="email" class="block text-gray-700">อีเมล:</label>
        <input type="email" id="email" name="email" class="bg-gray-100 border border-gray-300 rounded-md py-2 px-3 w-full" />
      </div>
      <div class="mb-4">
        <label for="is_staff" class="block text-gray-700">Is Staff:</label>
        <input type="checkbox" id="is_staff" name="is_staff" class="bg-gray-100 border border-gray-300 rounded-md py-2 px-3" />
      </div>
      <div class="flex justify-between">
        <button type="button" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded" onclick="closeAddUserModal()">ยกเลิก</button>
        <button type="submit" class="bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded">เพิ่มผู้ใช้</button>
      </div>
    </form>
  </div>
</div>

<!-- Edit User Modal -->
<div
id="editUserModal"
class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden"
>
  <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-lg">
      <h2 class="text-xl font-bold mb-4">แก้ไขผู้ใช้</h2>
      <form id="editUserForm" method="POST">
          {% csrf_token %}
          <input type="hidden" id="edit_user_id" name="user_id" />
          <div class="mb-4">
              <label for="edit_sid" class="block text-gray-700">รหัสนักศึกษา:</label>
              <input
                type="text"
                id="edit_sid"
                name="sid"
                class="bg-gray-100 border border-gray-300 rounded-md py-2 px-3 w-full"
              />
          </div>
          <div class="mb-4">
              <label for="edit_name" class="block text-gray-700">ชื่อ:</label>
              <input
                type="text"
                id="edit_name"
                name="name"
                class="bg-gray-100 border border-gray-300 rounded-md py-2 px-3 w-full"
              />
          </div>
          <div class="mb-4">
              <label for="edit_last_name" class="block text-gray-700">นามสกุุล:</label>
              <input
                type="text"
                id="edit_last_name"
                name="last_name"
                class="bg-gray-100 border border-gray-300 rounded-md py-2 px-3 w-full"
              />
          </div>
          <div class="mb-4">
              <label for="edit_branch" class="block text-gray-700">สาขา:</label>
              <input
                type="text"
                id="edit_branch"
                name="branch"
                class="bg-gray-100 border border-gray-300 rounded-md py-2 px-3 w-full"
              />
          </div>
          <div class="mb-4">
            <label for="edit_email" class="block text-gray-700">อีเมล:</label>
            <input
              type="email"
              id="edit_email"
              name="email"
              class="bg-gray-100 border border-gray-300 rounded-md py-2 px-3 w-full"
            />
          </div>
          <div class="mb-4">
              <label for="edit_is_staff" class="block text-gray-700">Is Staff:</label>
              <input
                type="checkbox"
                id="edit_is_staff"
                name="is_staff"
                class="bg-gray-100 border border-gray-300 rounded-md py-2 px-3"
              />
          </div>
          <div class="flex justify-between">
              <button
                type="button"
                class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded"
                onclick="closeEditUserModal()"
              >
                ยกเลิก
              </button>
              <button
                type="submit"
                class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded"
              >
                บันทึกข้อมูล
              </button>
          </div>
      </form>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  function confirmDeleteUser(userId) {
    Swal.fire({
      title: 'ลบข้อมูล',
      text: "จะลบหรือไม่?",
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#3085d6',
      cancelButtonColor: '#d33',
      confirmButtonText: 'ใช่',
      cancelButtonText: 'ไม่'
    }).then((result) => {
      if (result.isConfirmed) {
        // Redirect to the delete URL if confirmed
        window.location.href = '/delete_user/' + userId + '/';
      }
    });
    }

  function openAddUserModal() {
    document.getElementById("addUserModal").classList.remove("hidden");
    document.body.classList.add("modal-open");
  }

  function closeAddUserModal() {
    document.getElementById("addUserModal").classList.add("hidden");
    document.body.classList.remove("modal-open");
  }

  function openEditUserModal(userId) {
    // Make an AJAX request to get the user data
    fetch(`/get_user_data/${userId}/`)
      .then((response) => response.json())
      .then((data) => {
        document.getElementById("edit_user_id").value = userId;
        document.getElementById("edit_sid").value = data.sid;
        document.getElementById("edit_name").value = data.name;
        document.getElementById("edit_last_name").value = data.last_name;
        document.getElementById("edit_branch").value = data.branch;
        document.getElementById("edit_is_staff").checked = data.is_staff;
        document.getElementById("edit_email").value = data.email;
        document.getElementById("editUserForm").action = `/edit_user/${userId}/`;
        document.getElementById("editUserModal").classList.remove("hidden");
      })
      .catch((error) => {
        console.error("Error fetching user data: ", error);
        alert("Failed to fetch user details.");
      });
  }

  function closeEditUserModal() {
    document.getElementById("editUserModal").classList.add("hidden");
    document.body.classList.remove("modal-open");
  }
  $(document).ready(function () {
    $(".dataTable").DataTable({
      language: {
        sProcessing: "กำลังประมวลผล...",
        sLengthMenu: "แสดง _MENU_ รายการ",
        sZeroRecords: "ไม่พบข้อมูล",
        sInfo: "แสดง _START_ ถึง _END_ จาก _TOTAL_ รายการ",
        sInfoEmpty: "แสดง 0 ถึง 0 จาก 0 รายการ",
        sInfoFiltered: "(กรองจาก _MAX_ รายการทั้งหมด)",
        sSearch: "ค้นหา:",
        oPaginate: {
          sFirst: "หน้าแรก",
          sPrevious: "ก่อนหน้า",
          sNext: "ถัดไป",
          sLast: "หน้าสุดท้าย"
        }
      }
    });
    });
</script>
{% endblock %}
