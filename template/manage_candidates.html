{% extends 'base.html' %} {% block title %}Manage Candidates{% endblock %} 
{%block content %}
<div class="bg-white p-6 rounded-lg shadow-md">
  <h1 class="text-2xl font-bold mb-6">จัดการผู้สมัคร</h1>

  <!-- Add Candidate Modal Button -->
  <button
    onclick="openAddCandidateModal()"
    class="bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded mb-4"
  >
    เพิ่มผู้สมัครคนใหม่
  </button>

  <!-- Add Candidate Modal -->
  <div id="addCandidateModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden modal">
    <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-lg modal-content">
      <h2 class="text-xl font-bold mb-4">เพิ่มผู้สมัครคนใหม่</h2>
      <form method="POST" class="space-y-4" enctype="multipart/form-data" onsubmit="handleSubmit(this)">
        {% csrf_token %}
        <div class="mb-4">
          <label for="number" class="block text-gray-700">หมายเลขผู้สมัคร:</label>
          <input
            type="text"
            id="number"
            name="number"
            class="bg-gray-100 border border-gray-300 rounded-md py-2 px-3 w-full"
          />
        </div>
        <div class="mb-4">
          <label for="name" class="block text-gray-700">ชื่อ:</label>
          <input
            type="text"
            id="name"
            name="name"
            class="bg-gray-100 border border-gray-300 rounded-md py-2 px-3 w-full"
          />
        </div>
        
        <div class="mb-4">
          <label for="last_name" class="block text-gray-700">นามสกุล:</label>
          <input
            type="text"
            id="last_name"
            name="last_name"
            class="bg-gray-100 border border-gray-300 rounded-md py-2 px-3 w-full"
          />
        </div>
        <div class="mb-4">
          <label for="election_round" class="block text-gray-700"
            >รอบการเลือกตั้ง:</label
          >
          <select
            id="election_round"
            name="election_round"
            class="bg-gray-100 border border-gray-300 rounded-md py-2 px-3 w-full"
          >
            {% for round in election_rounds %}
            <option value="{{ round.id }}">{{ round.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="mb-4">
          <label for="detail" class="block text-gray-700">นโยบาย:</label>
          <textarea
            id="detail"
            name="detail"
            class="bg-gray-100 border border-gray-300 rounded-md py-2 px-3 w-full"
          ></textarea>
        </div>
        <div class="mb-4">
          <label for="branch" class="block text-gray-700">สาขา:</label>
          <input
            type="text"
            id="branch"
            name="branch"
            class="bg-gray-100 border border-gray-300 rounded-md py-2 px-3 w-full"
          />
        </div>
        <div class="mb-4">
          <label for="year" class="block text-gray-700">ชั้นปี:</label>
          <input
            type="number"
            id="year"
            name="year"
            class="bg-gray-100 border border-gray-300 rounded-md py-2 px-3 w-full"
          />
        </div>
        <div class="mb-4">
          <label for="picture" class="block text-gray-700"
            >รูปผู้สมัคร:</label
          >
          <input
            type="file"
            id="picture"
            name="picture"
            class="bg-gray-100 border border-gray-300 rounded-md py-2 px-3 w-full"
          />
        </div>

        <div class="flex justify-between">
          <button
            type="button"
            class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded"
            onclick="closeAddCandidateModal()"
          >
            ยกเลิก
          </button>
          <button
            type="submit"
            class="bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded"
          >
            เพิ่มผู้สมัครคนใหม่
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit Candidate Modal -->
  <div
    id="editCandidateModal"
    class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden modal"
  >
    <div
      class="bg-white p-6 rounded-lg shadow-lg w-full max-w-lg modal-content"
    >
      <h2 class="text-xl font-bold mb-4">แก้ไขผู้สมัคร</h2>
      <form
        id="editCandidateForm"
        method="POST"
        action=""
        enctype="multipart/form-data"
        onsubmit="handleSubmit(this)"
      >
        {% csrf_token %}
        <!-- Include candidate ID as a hidden input -->
        <input type="hidden" id="edit_candidate_id" name="candidate_id" />
        <div class="mb-4">
          <label for="edit_number" class="block text-gray-700"
            >หมายเลขผู้สมัคร:</label
          >
          <input
            type="text"
            id="edit_number"
            name="number"
            class="bg-gray-100 border border-gray-300 rounded-md py-2 px-3 w-full"
          />
        </div>
        <div class="mb-4">
          <label for="edit_name" class="block text-gray-700"
            >ชื่อ:</label
          >
          <input
            type="text"
            id="edit_name"
            name="name"
            class="bg-gray-100 border border-gray-300 rounded-md py-2 px-3 w-full"
          />
        </div>
        
        <div class="mb-4">
          <label for="edit_last_name" class="block text-gray-700"
            >นามสกุล:</label
          >
          <input
            type="text"
            id="edit_last_name"
            name="last_name"
            class="bg-gray-100 border border-gray-300 rounded-md py-2 px-3 w-full"
          />
        </div>
        <div class="mb-4">
          <label for="edit_election_round" class="block text-gray-700"
            >รอบการเลือกตั้ง:</label
          >
          <select
            id="edit_election_round"
            name="election_round"
            class="bg-gray-100 border border-gray-300 rounded-md py-2 px-3 w-full"
          >
          </select>
        </div>
        <div class="mb-4">
          <label for="edit_detail" class="block text-gray-700">นโยบาย:</label>
          <textarea
            id="edit_detail"
            name="detail"
            class="bg-gray-100 border border-gray-300 rounded-md py-2 px-3 w-full"
          ></textarea>
        </div>
        <div class="mb-4">
          <label for="edit_branch" class="block text-gray-700">สาขา:</label>
          <input
            type="text"
            id="edit_branch"
            name="branch"
            class="bg-gray-100 border border-gray-300 rounded-md py-2 px-3 w-full"
          />
        </div>
        <div class="mb-4">
          <label for="edit_year" class="block text-gray-700">ชั้นปี:</label>
          <input
            type="number"
            id="edit_year"
            name="year"
            class="bg-gray-100 border border-gray-300 rounded-md py-2 px-3 w-full"
          />
        </div>

        <!-- New Picture Field for Editing -->
        <div class="mb-4">
          <label for="edit_picture" class="block text-gray-700"
            >รูปผู้สมัคร:</label
          >
          <input
            type="file"
            id="edit_picture"
            name="picture"
            class="bg-gray-100 border border-gray-300 rounded-md py-2 px-3 w-full"
          />
        </div>

        <div class="flex justify-between">
          <button
            type="button"
            class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded"
            onclick="closeEditCandidateModal()"
          >
            ยกเลิก
          </button>
          <button
            type="submit"
            class="bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded"
          >
            บันทึก
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Existing Candidates Table -->

  <div class="overflow-x-auto">
    <table
      id="candidatesTable"
      class="dataTable min-w-full bg-white border border-gray-300 rounded-lg"
    >
      <thead>
        <tr class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
          <th class="py-3 px-6 text-left">หมายเลขผู้สมัคร</th>
          <th class="py-3 px-6 text-left">ชื่อ</th>
          <th class="py-3 px-6 text-left">นามสกุล</th>
          <th class="py-3 px-6 text-left">นโยบาย</th>
          <th class="py-3 px-6 text-left">สาขา</th>
          <th class="py-3 px-6 text-left">ชั้นปี</th>
          <th class="py-3 px-6 text-left">รอบการเลือกตั้ง</th>
          <th class="py-3 px-6 text-left">รูปผู้สมัคร</th>
          <!-- Add this -->
          <th class="py-3 px-6 text-center">Actions</th>
        </tr>
      </thead>
      <tbody class="text-gray-700 text-sm font-light">
        {% for candidate in candidates %}
        <tr class="border-b border-gray-200 hover:bg-gray-100">
          <td class="py-3 px-6 text-left">{{ candidate.number }}</td>
          <td class="py-3 px-6 text-left">{{ candidate.name }}</td>
          <td class="py-3 px-6 text-left">{{ candidate.last_name }}</td>
          <td class="py-3 px-6 text-left">{{ candidate.detail }}</td>
          <td class="py-3 px-6 text-left">{{ candidate.branch }}</td>
          <td class="py-3 px-6 text-left">{{ candidate.year }}</td>
          <td class="py-3 px-6 text-left">
            {{ candidate.election_round.name }}
          </td>
          <td class="py-3 px-6 text-left">
            {% if candidate.picture %}
            <img
              src="{{ candidate.picture.url }}"
              alt="{{ candidate.name }}"
              class="w-16 h-16 rounded"
            />
            {% else %} ไม่มีรูปภาพ {% endif %}
          </td>
          <!-- Add this block for picture -->
          <td class="py-3 px-6 text-center">
            <button
              onclick="openEditCandidateModal('{{ candidate.id }}')"
              class="bg-blue-500 hover:bg-blue-600 text-white py-1 px-3 rounded"
            >
              แก้ไข
            </button>
            <button
            onclick="confirmDeleteCandidate('{{ candidate.id }}')"
              class="bg-red-500 hover:bg-red-600 text-white py-1 px-3 rounded ml-2"
              >ลบ</button
            >
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %} 
{% block extra_scripts %}
<script>
  function confirmDeleteCandidate(candidateID) {
    Swal.fire({
      title: 'ลบข้อมูล',
      text: "จะลบหรือไม่?",
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#3085d6',
      cancelButtonColor: '#d33',
      confirmButtonText: 'ใช่',
      cancelButtonText: 'ไม่'
    }).then((result) => {
      if (result.isConfirmed) {
        // Redirect to the delete URL if confirmed
        window.location.href = '/delete_candidate/' + candidateID + '/';
      }
    });
    }

  // Function to open the Add Candidate modal
  function openAddCandidateModal() {
    const modal = document.getElementById("addCandidateModal");
    modal.classList.remove("hidden"); // Show the modal
    document.body.classList.add("modal-open"); // Prevent scrolling
  }

  // Function to close the Add Candidate modal
  function closeAddCandidateModal() {
    const modal = document.getElementById("addCandidateModal");
    modal.classList.add("hidden"); // Hide the modal
    document.body.classList.remove("modal-open"); // Re-enable scrolling
  }

  function openEditCandidateModal(candidateId) {
    fetch(`/get_candidate_data/${candidateId}/`)
      .then((response) => response.json())
      .then((data) => {
        document.getElementById("edit_candidate_id").value = candidateId;
        document.getElementById("edit_number").value = data.number;
        document.getElementById("edit_name").value = data.name;
        document.getElementById("edit_last_name").value = data.last_name;
        document.getElementById("edit_detail").value = data.detail;
        document.getElementById("edit_branch").value = data.branch;
        document.getElementById("edit_year").value = data.year;
        // Set the action to submit the form to update the candidate
        document.getElementById(
          "editCandidateForm"
        ).action = `/edit_candidate/${candidateId}/`;

        // Populate election round dropdown
        const electionRoundSelect = document.getElementById(
          "edit_election_round"
        );
        electionRoundSelect.innerHTML = ""; // Clear the dropdown
        fetchElectionRounds().then((electionRounds) => {
          electionRounds.forEach((round) => {
            const option = document.createElement("option");
            option.value = round.id;
            option.text = round.name;
            electionRoundSelect.appendChild(option);
            if (round.id === data.election_round_id) {
              electionRoundSelect.value = round.id; // Set selected value
            }
          });
        });

        // Show the modal
        document
          .getElementById("editCandidateModal")
          .classList.remove("hidden");
        document.body.classList.add("modal-open");
      })
      .catch((error) => {
        console.error("Failed to fetch candidate details: ", error);
        alert("Failed to fetch candidate details.");
      });
  }

  function closeEditCandidateModal() {
    document.getElementById("editCandidateModal").classList.add("hidden");
    document.body.classList.remove("modal-open");
  }

  function fetchElectionRounds() {
    return fetch("/get_election_rounds/")
      .then((response) => response.json())
      .then((data) => data.election_rounds)
      .catch((error) => {
        console.error("Failed to fetch election rounds:", error);
        return []; // Return empty array in case of error
      });
  }

  // Initialize DataTables
  $(document).ready(function () {
    $(".dataTable").DataTable();
  });
  function handleSubmit(form) {
    // Disable the submit button and change its text
    const submitButton = form.querySelector('button[type="submit"]');
    submitButton.disabled = true;
    submitButton.textContent = 'กำลังโหลด...';
    
    // Optional: Add a class to indicate loading (if needed for styling)
    submitButton.classList.add('cursor-not-allowed', 'opacity-50');
  }
</script>
{% endblock %}
