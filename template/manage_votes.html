{% extends 'base.html' %}
{% block title %}ดูผลโหวต{% endblock %}

{% block content %}
<div class="bg-white p-6 rounded-lg shadow-md">
  <h1 class="text-2xl font-bold mb-6">ดูผลโหวต</h1>

  <!-- List of rounds -->
  <div class="overflow-x-auto">
    <table class="dataTable min-w-full bg-white border border-gray-300 rounded-lg">
      <thead class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
        <tr>
          <th class="py-3 px-6 text-left">ชื่อรอบ</th>
          <th class="py-3 px-6 text-left">Actions</th>
        </tr>
      </thead>
      <tbody class="text-gray-700 text-sm font-light">
        {% for round in rounds %}
        <tr class="border-b border-gray-200 hover:bg-gray-100">
          <td class="py-3 px-6">{{ round.name }}</td>
          <td class="py-3 px-6">
            <button
              onclick="openVoteModal('{{ round.id }}')"
              class="bg-blue-500 hover:bg-blue-600 text-white py-1 px-3 rounded"
            >
              ดูรายละเอียด
            </button>
          </td>
          
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Vote Details Modal -->
<div
  id="voteModal"
  class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center hidden"
>
  <div class="bg-white p-6 rounded-lg shadow-lg w-full max-w-lg">
    <h2 class="text-xl font-bold mb-4">รายระเอียดของรอบนี้</h2>
    
    <table class="min-w-full bg-white border border-gray-300 rounded-lg">
      <thead>
        <tr class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
          <th class="py-3 px-6 text-left">ชื่อ</th>
          <th class="py-3 px-6 text-left">นามสกุุล</th>
          <th class="py-3 px-6 text-left">จำนวนโหวต</th>
        </tr>
      </thead>
      <tbody id="voteDetailsBody">
        <!-- Vote details will be dynamically loaded here -->
      </tbody>
    </table>
    
    <!-- Add the additional section for total votes, start, end date, and absent votes -->
    <div class="mt-4">
      <p id="totalVotes" class="font-bold">โหวตรวม: </p>
      <p id="absentVotes" class="font-bold text-red-500">ไม่ประสงค์ลงคะแนน: </p>
      <p id="startDate" class="text-gray-600">วันและเวลาที่เริ่มเปิดหีบ: </p>
      <p id="endDate" class="text-gray-600">วันและเวลาที่ปิดหีบ: </p>
    </div>

    <div class="mt-4 flex justify-between">
      <button class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded" onclick="closeVoteModal()">ปิด</button>
      <button id="generatePdfButton" class="bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded" onclick="generatePdf('{{ round.id }}')">ดาวน์โหลดเอกสาร</button>

    </div>
  </div>
</div>



{% endblock %}

{% block extra_scripts %}
<script>
  function generatePdf(roundId) {
    // Redirect to the download URL
    window.location.href = `/download_pdf_results/${roundId}/`;
  }

  function openVoteModal(roundId) {
  console.log("Round ID:", roundId);
  fetch(`/get_round_votes/${roundId}/`)
    .then((response) => response.json())
    .then((data) => {
      if (data.vote_data) {
        const voteDetails = data.vote_data.map(vote => `
          <tr>
            <td>${vote.name}</td>
            <td>${vote.last_name}</td>
            <td>${vote.total_votes}</td>
          </tr>
        `).join('');
        
        // Insert candidate vote details
        document.getElementById('voteDetailsBody').innerHTML = voteDetails;
        
        // Display total votes
        document.getElementById('totalVotes').textContent = `โหวตรวม: ${data.total_votes}`;
        
        // Display absent votes
        document.getElementById('absentVotes').textContent = `ไม่ประสงค์ลงคะแนน: ${data.absent_votes}`;
        
        // Update start and end dates
        document.getElementById('startDate').textContent = `วันและเวลาที่เริ่มเปิดหีบ: ${data.start_date}`;
        document.getElementById('endDate').textContent = `วันและเวลาที่ปิดหีบ: ${data.end_date}`;
      }
      document.getElementById('generatePdfButton').setAttribute('onclick', `generatePdf(${roundId})`);
      document.getElementById('voteModal').classList.remove('hidden');
    })
    .catch((error) => {
      console.error('Error fetching vote details:', error);
      alert('Failed to load vote details.');
    });
}


  function closeVoteModal() {
    document.getElementById('voteModal').classList.add('hidden');
  }

  $(document).ready(function () {
    $(".dataTable").DataTable({
      language: {
        sProcessing: "กำลังประมวลผล...",
        sLengthMenu: "แสดง _MENU_ รายการ",
        sZeroRecords: "ไม่พบข้อมูล",
        sInfo: "แสดง _START_ ถึง _END_ จาก _TOTAL_ รายการ",
        sInfoEmpty: "แสดง 0 ถึง 0 จาก 0 รายการ",
        sInfoFiltered: "(กรองจาก _MAX_ รายการทั้งหมด)",
        sSearch: "ค้นหา:",
        oPaginate: {
          sFirst: "หน้าแรก",
          sPrevious: "ก่อนหน้า",
          sNext: "ถัดไป",
          sLast: "หน้าสุดท้าย"
        }
      }
    });
    });
</script>

{% endblock %}
